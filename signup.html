<!doctype html>
<head>
    <meta charset="utf-8">

    <title>PRA Workday Signup</title>
    <meta name="description" content="PRA Workday Signup">

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.0.min.js"></script>
</head>

<body>

<script type="text/javascript">
    Parse.initialize("LzoGzGiknLdEUXmyB04WsMS3t564Xl9m9DhFIo6D", "lxPUR3V3ZNA72WqYSD0K8DgVxb6XWzCOvS5CiKcM");

    function buildOptionFromParse(value, label) {
        return "<option value='" + value + "'>" + label + "</option>";
    }
    function handleSubmit(form) {
        var data = {};
        //Gathering the Data
        //and removing undefined keys(buttons)
        $.each(form.elements, function (i, v) {
            var input = $(v);
            data[input.attr("name")] = input.val();
            delete data["undefined"];
        });


        var Signup = Parse.Object.extend("Signup");
        var savedSignup = new Signup();
		console.log(data["job"]);
		var job = JSON.parse(data["job"]);
        savedSignup.set("name", data["name"]);
        savedSignup.set("event", data["date"]);	
		savedSignup.set("job_title", job.job_title);
		savedSignup.set("job_day", job.job_day);
		savedSignup.set("point_value", job.point_value);
		savedSignup.set("cash_value", job.cash_value);
		savedSignup.set("meal_ticket", job.meal_ticket);
		savedSignup.set("sort_order", job.sort_order);
		savedSignup.set("job_day", job.job_day);					
		savedSignup.set("job_id", job.objectId);
        //savedSignup.set("job", JSON.parse(data["job"]));
        savedSignup.save(null, {
            success: function (savedSignup) {
                // Execute any logic that should take place after the object is saved.
                console.log('New object created with objectId: ' + savedSignup.id);
            },
            error: function (savedSignup, error) {
                // Execute any logic that should take place if the save fails.
                // error is a Parse.Error with an error code and message.
                //alert('Failed to create new object, with error code: ' + error.message);
            }
        });
		Parse.Cloud.run('sendJobNotification', 
			{ 
				event: data["date"],
				name: data["name"],
				job: job.job_title
			}, {
			success: function(ratings) {
				// ratings should be 4.5
			},
			error: function(error) {
			}
		});
        console.log(JSON.stringify(savedSignup));
		var signupAgain = confirm(data["name"] + ", thanks for your help!  Your signup for " + job.job_title + " on " + 
			job.job_day + " on the event weekend of " + data["date"] + " has been recorded.\n\n" +
			"Click a button and sign up for another job, or close the window to return to the website." 			
		);

		if (signupAgain) {
			window.Location.reload(true);
		} else {
			window.Location.reload(true);
		}
        return false;
    }

    function populateJobs() {
        // get all the signups for the picked date
        var selectedDateId = $("#date").val();
        $("#job").html("");

        // now get all the jobs for this date, filtering the still available ones (ones that dont' have a signup).
        // Parse doesn't have a "not in" clause query so we have to get creative with this.  Keep an eye out for a
        // not in clause in the future.
        // get the signups for this date
        var signupQuery = new Parse.Query("Signup");
        var signupJobIds = new Array();
        signupQuery.equalTo("event", selectedDateId);
        signupQuery.select("event", "job_id");
        signupQuery.find({
            success: function (signupResults) {
                for (var index = 0; index < signupResults.length; index++) {
                    //alert(JSON.stringify(signupResults[index]));
                    signupJobIds.push(signupResults[index].get("job_id"));
                }
            }
        });
        //alert(JSON.stringify(signupJobIds));
        //Parse.Cloud.run("listJobs", {event_id: selectedDateId}, {
        var jobQuery = new Parse.Query("Jobs");
        jobQuery.equalTo("reserved", false);
        jobQuery.ascending("sort_order");
        jobQuery.find({
            success: function (results) {
                var listItems = "";
                for (var i = 0; i < results.length; i++) {
                    var job = results[i];
                    if (signupJobIds.indexOf(job.id) == -1) {
                        listItems += buildOptionFromParse(
                                JSON.stringify(job), job.get("job_title")
                        );
                    }
                }

                $("#job").html(listItems);
            },
            error: function (error) {
                alert("Error: " + error.code + " " + error.message);
            }
        });
    }
    Parse.Cloud.run("listEvents", {}, {
        success: function (results) {
            var listItems = buildOptionFromParse("", "Select a date");
            for (var i = 0; i < results.length; i++) {
                var object = results[i];
                var eventDate = object.get("eventDate");
                var dateString = eventDate.getMonth() + 1 + "-" + eventDate.getDate() + "-" + eventDate.getFullYear();
                listItems += buildOptionFromParse(dateString, dateString);
            }

            $("#date").html(listItems);
        },
        error: function (error) {
        }
    });


</script>

<form class="form-horizontal" method="post" onsubmit="return handleSubmit(this)">
    <fieldset>

        <!-- Form Name -->
        <legend>PRA signup form</legend>

        Please choose a date, then a job below.  The jobs list for a given date is up to date - so if what you see on
        the list is what is currently available.

        <!-- Text input-->
        <div class="form-group">
            <label class="col-md-4 control-label" for="name">Name</label>

            <div class="col-md-6">
                <input id="name" name="name" type="text" placeholder="" class="form-control input-md" required="">

            </div>
        </div>

        <!-- Select Basic -->
        <div class="form-group">
            <label class="col-md-4 control-label" for="date">Choose Event</label>

            <div class="col-md-6">
                <select id="date" name="date" class="form-control" onchange="populateJobs()">
                </select>
            </div>
        </div>

        <!-- Select Multiple -->
        <div class="form-group">
            <label class="col-md-4 control-label" for="job">Job</label>

            <div class="col-md-6" height="600">
                <select id="job" name="job" class="form-control">
                </select>
            </div>
        </div>

        <!-- Button -->
        <div class="form-group">
            <label class="col-md-4 control-label" for=""></label>

            <div class="col-md-4">
                <button id="" name="" class="btn btn-success">Submit</button>
            </div>
        </div>

    </fieldset>
</form>

</body>

</html>
